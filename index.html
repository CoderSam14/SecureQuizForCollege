<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strict Secure Quiz — Hybrid (Persistent Lock, Stable Resume)</title>
  <style>
    html,body{height:100%;width:100%;margin:0;padding:0;background:#000;color:#fff;font-family:Inter,Arial,sans-serif;overflow:hidden}
    iframe{width:100%;height:100%;border:0;display:none;background:#111}
    #overlay{
      position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;
      justify-content:center;align-items:center;padding:24px;text-align:center;gap:10px
    }
    #overlay h1{margin:0 0 8px;font-size:22px;line-height:1.25;font-weight:600}
    #overlay p{margin:0;color:#cfcfcf}
    #overlay .hint{font-size:12px;color:#9a9a9a;margin-top:10px}
    .row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    button{font-size:16px;padding:12px 18px;border-radius:10px;border:0;cursor:pointer;min-width:140px;transition:transform .06s ease,opacity .12s ease}
    button:active{transform:translateY(1px)} button:disabled{opacity:.5;cursor:not-allowed}
    #startBtn{background:#0b9d58;color:#fff;display:inline-block}
    #resumeBtn{background:#f59f00;color:#fff;display:none}

    *{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
    img{-webkit-user-drag:none;user-drag:none;pointer-events:none}
    ::-webkit-scrollbar{display:none}
    ::selection{background:transparent}::-moz-selection{background:transparent}
  </style>
</head>
<body>

  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayText">
    <h1 id="overlayText">Click Start to Begin Quiz</h1>
    <div class="row">
      <button id="startBtn">Start Quiz</button>
      <button id="resumeBtn">Resume Quiz</button>
    </div>
    <p id="subText" class="hint">Before starting, only opening DevTools will block you. After starting, policy applies.</p>
  </div>

  <iframe
    id="quizFrame"
    src="https://vitapcolab129.examly.io/login"
    title="Quiz"
    allow="fullscreen"
    sandbox="allow-forms allow-scripts allow-same-origin"
  ></iframe>

  <script>
  (function(){
    'use strict';

    /* ===== DOM ===== */
    const overlay   = document.getElementById('overlay');
    const titleEl   = document.getElementById('overlayText');
    const subEl     = document.getElementById('subText');
    const startBtn  = document.getElementById('startBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const quizFrame = document.getElementById('quizFrame');

    function showOverlay(t,s){ if(t) titleEl.innerText=t; if(s!==undefined) subEl.innerText=s; overlay.style.display='flex'; }
    function hideOverlay(){ overlay.style.display='none'; }

    /* ===== Config ===== */
    const NORMAL_MAX_STRIKES   = 3;      // non-DevTools violations allowed after Start
    const FULLSCREEN_GRACE_MS  = 3500;   // grace window after FS changes/resume
    const PERF_GAP_MS          = 2000;   // perf drift threshold
    const RESUME_GRACE_MS      = 1200;   // ignore checks briefly after resume to avoid false positives
    const RESUME_GRACE_FRAMES  = 8;      // or frames grace, whichever ends first
    const LOCK_KEY             = 'quiz_lock_v3';
    const LOCK_MINUTES         = 60;     // persistent lock duration

    /* ===== State ===== */
    let hasStarted=false, locked=false;
    let normalStrikes=0;
    let fsGraceUntil=0;
    let rafId=null;
    let lastPerf=0;
    let resumeGraceUntil=0;
    let resumeGraceFrames=0;

    /* ===== Originals ===== */
    const ORIGINAL={
      addEventListener: EventTarget.prototype.addEventListener,
      requestAnimationFrame: window.requestAnimationFrame.bind(window),
      cancelAnimationFrame: window.cancelAnimationFrame ? window.cancelAnimationFrame.bind(window) : null,
      perfNow: (performance&&performance.now)?performance.now.bind(performance):Date.now.bind(Date),
      hasFocus: document.hasFocus?document.hasFocus.bind(document):()=>true,
      visGet: (()=>{const d=Object.getOwnPropertyDescriptor(Document.prototype,'visibilityState');return d&&d.get?d.get.bind(document):()=>document.visibilityState;})(),
      console: {
        log: console.log.bind(console),
        info: console.info?console.info.bind(console):console.log.bind(console),
        warn: console.warn?console.warn.bind(console):console.log.bind(console),
        error: console.error?console.error.bind(console):console.log.bind(console),
        table: console.table?console.table.bind(console):function(){},
        trace: console.trace?console.trace.bind(console):function(){},
        debug: console.debug?console.debug.bind(console):console.log.bind(console),
      }
    };
    function on(t,ev,fn,opts){ try{ ORIGINAL.addEventListener.call(t,ev,fn,opts); }catch{ t.addEventListener(ev,fn,opts); } }

    /* ===== Persistent lock ===== */
    function makeLock(reason){ return { reason:String(reason||'policy violation'), expiry: Date.now()+LOCK_MINUTES*60*1000 }; }
    function setLock(reason){
      const lock=makeLock(reason);
      try{
        localStorage.setItem(LOCK_KEY, JSON.stringify(lock));
        sessionStorage.setItem(LOCK_KEY, JSON.stringify(lock));
      }catch{}
      applyLock(lock);
      // optional IndexedDB (best effort)
      try {
        const req=indexedDB.open('quiz-lock-store',1);
        req.onupgradeneeded=e=>{
          const db=e.target.result;
          if(!db.objectStoreNames.contains('locks')) db.createObjectStore('locks');
        };
        req.onsuccess=e=>{
          const db=e.target.result;
          try{ const tx=db.transaction('locks','readwrite'); tx.objectStore('locks').put(lock,'persistentLock'); tx.oncomplete=()=>db.close(); }catch{ db.close(); }
        };
      }catch{}
    }
    function readLock(){
      try{
        const raw=localStorage.getItem(LOCK_KEY);
        if(!raw) return null;
        const o=JSON.parse(raw);
        if(!o||!o.expiry) return null;
        if(Date.now()>=o.expiry){ localStorage.removeItem(LOCK_KEY); sessionStorage.removeItem(LOCK_KEY); return null; }
        return o;
      }catch{ return null; }
    }
    function applyLock(lock){
      locked=true;
      try{ quizFrame.style.display='none'; }catch{}
      try{
        showOverlay(`❌ Blocked: ${lock.reason}`, `Locked until ${new Date(lock.expiry).toLocaleString()}`);
        startBtn.style.display='none'; resumeBtn.style.display='none';
      }catch{}
      stopWatchdogs();
      // stop detectors
      preQuizIntervals.forEach(id=>clearInterval(id));
      postStartIntervals.forEach(id=>clearInterval(id));
    }

    // Check lock on load
    const existingLock = readLock();
    if(existingLock){ applyLock(existingLock); return; }

    /* ===== Fullscreen helpers ===== */
    function requestFullscreen(){
      const el=document.documentElement;
      const rfs=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen||el.webkitEnterFullscreen;
      if(rfs){ try{ return Promise.resolve(rfs.call(el)); }catch{ return Promise.resolve(); } }
      return Promise.resolve();
    }
    function isBrowserUIFullscreen(){
      try{ return Math.abs(window.innerHeight-screen.availHeight)<=1 && Math.abs(window.innerWidth-screen.availWidth)<=1; }catch{ return false; }
    }
    function inFullscreen(){
      const fs=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||null;
      return !!fs || isBrowserUIFullscreen();
    }

    /* ===== Block / Warn flows ===== */
    function hardBlock(reason){ if(locked) return; setLock(reason||'policy violation'); }

    function warnStrike(reason){
      if(locked) return;
      normalStrikes++;
      if(normalStrikes>=NORMAL_MAX_STRIKES) return hardBlock('Too many violations');

      // Pause watchdog to prevent cascading errors while overlay is shown
      stopWatchdogs();

      quizFrame.style.display='none';
      showOverlay(`⚠️ ${reason}`, `Warning ${normalStrikes}/${NORMAL_MAX_STRIKES}. Click "Resume Quiz" to continue.`);
      startBtn.style.display='none'; resumeBtn.style.display='inline-block';
    }

    /* ===== Start / Resume ===== */
    function startQuiz(){
      if(locked) return;
      hasStarted=true;
      requestFullscreen().then(()=>{
        hideOverlay();
        quizFrame.style.display='block';

        // Reset timers / grace so no immediate false positives
        lastPerf=ORIGINAL.perfNow();
        fsGraceUntil = Date.now()+FULLSCREEN_GRACE_MS;
        resumeGraceUntil = Date.now()+RESUME_GRACE_MS;
        resumeGraceFrames = RESUME_GRACE_FRAMES;

        // start watchdog + post-start detectors
        setTimeout(()=>{
          startWatchdogs();
          startPostStartDevtoolsDetectors();
          wirePostStartShortcuts();
          wireContextMenuPostStart();
        }, 150);
      });
    }

    function resumeQuiz(){
      if(locked) return;
      if(!hasStarted) return startQuiz();

      requestFullscreen().then(()=>{
        hideOverlay();
        quizFrame.style.display='block';

        // Reset timers / grace again before restarting watchdog
        lastPerf=ORIGINAL.perfNow();
        fsGraceUntil = Date.now()+FULLSCREEN_GRACE_MS;
        resumeGraceUntil = Date.now()+RESUME_GRACE_MS;
        resumeGraceFrames = RESUME_GRACE_FRAMES;

        startWatchdogs(); // restart loop cleanly
      });
    }

    startBtn.addEventListener('click', startQuiz);
    resumeBtn.addEventListener('click', resumeQuiz);

    // Optional: F11 to start
    on(document,'keydown',e=>{ if(!hasStarted && !locked && e.key==='F11'){ e.preventDefault(); startQuiz(); } },{capture:true});

    /* ===== Pre-quiz: DevTools-only blocking (persistent) ===== */
    const preQuizIntervals=[];

    // A) DOM element probe loop (reliable on Chromium)
    (function preProbe(){
      try{
        const img = new Image();
        Object.defineProperty(img,'id',{ get(){ if(!hasStarted && !locked) hardBlock('DevTools opened (pre-quiz)'); return 'x'; }});
        preQuizIntervals.push(setInterval(()=>{ if(locked||hasStarted) return; ORIGINAL.console.log(img); }, 1000));
      }catch{}
    })();

    // B) Docked DevTools gap
    preQuizIntervals.push(setInterval(()=>{
      if(locked||hasStarted) return;
      const gapH=Math.abs(window.outerHeight-window.innerHeight);
      const gapW=Math.abs(window.outerWidth-window.innerWidth);
      if(gapH>160||gapW>160) hardBlock('DevTools detected (pre-quiz)');
    }, 900));

    // C) Timing anomaly
    preQuizIntervals.push(setInterval(()=>{
      if(locked||hasStarted) return;
      const t0=ORIGINAL.perfNow(); Function.prototype.toString.call(function(){});
      const dt=ORIGINAL.perfNow()-t0;
      if(dt>175) hardBlock('DevTools timing anomaly (pre-quiz)');
    }, 1500));

    // D) Pre-quiz DevTools shortcuts only
    on(window,'keydown',e=>{
      if(locked||hasStarted) return;
      const k=(e.key||'').toLowerCase();
      const dev = e.key==='F12' || (e.ctrlKey&&e.shiftKey&&['i','j','c','k'].includes(k)) || (e.ctrlKey&&k==='u') || (e.metaKey&&e.altKey&&k==='i');
      if(dev){ e.preventDefault(); e.stopPropagation(); hardBlock('DevTools shortcut (pre-quiz)'); }
    }, {capture:true});

    // E) Mute user-visible console AFTER probe planting
    (function muteConsolePreQuiz(){
      const noop=()=>{};
      try{ console.log=noop; console.info=noop; console.warn=noop; console.error=noop; console.table=noop; console.trace=noop; console.debug=noop; }catch{}
    })();

    /* ===== Post-start: DevTools detectors (instant block, persistent) ===== */
    const postStartIntervals=[];
    function startPostStartDevtoolsDetectors(){
      // DOM probe
      (function postProbe(){
        try{
          const img=new Image();
          Object.defineProperty(img,'id',{ get(){ if(hasStarted && !locked) hardBlock('DevTools opened'); return 'x'; }});
          postStartIntervals.push(setInterval(()=>{ if(!hasStarted||locked) return; ORIGINAL.console.log(img); }, 1000));
        }catch{}
      })();
      // Size gap
      postStartIntervals.push(setInterval(()=>{
        if(!hasStarted||locked) return;
        const gapH=Math.abs(window.outerHeight-window.innerHeight);
        const gapW=Math.abs(window.outerWidth-window.innerWidth);
        if(gapH>160||gapW>160) hardBlock('DevTools detected');
      }, 900));
      // Timing anomaly
      postStartIntervals.push(setInterval(()=>{
        if(!hasStarted||locked) return;
        const t0=ORIGINAL.perfNow(); Function.prototype.toString.call(function(){});
        const dt=ORIGINAL.perfNow()-t0;
        if(dt>175) hardBlock('DevTools timing anomaly');
      }, 1500));
    }

    /* ===== Post-start: Shortcuts & context menu ===== */
    function wirePostStartShortcuts(){
      on(window,'keydown',e=>{
        if(!hasStarted||locked) return;
        const k=(e.key||'').toLowerCase();
        const dev = e.key==='F12' || (e.ctrlKey&&e.shiftKey&&['i','j','c','k'].includes(k)) || (e.ctrlKey&&k==='u') || (e.metaKey&&e.altKey&&k==='i');
        const closeOrRefresh = (e.ctrlKey&&(k==='w'||k==='q'||k==='r')) || k==='f5' || (e.metaKey&&(k==='w'||k==='q'||k==='r'));
        if(dev){ e.preventDefault(); e.stopPropagation(); return hardBlock('DevTools shortcut'); }
        if(closeOrRefresh){ e.preventDefault(); e.stopPropagation(); return warnStrike('Close/Refresh shortcut'); }
      }, {capture:true});
    }
    function wireContextMenuPostStart(){
      on(document,'contextmenu',e=>{
        if(!hasStarted||locked) return;
        e.preventDefault(); e.stopPropagation(); warnStrike('Right-click/context menu'); return false;
      }, {capture:true});
    }

    /* ===== Watchdog (rAF) ===== */
    function startWatchdogs(){
      if(rafId) return;
      lastPerf = ORIGINAL.perfNow(); // ensure fresh baseline
      rafId = ORIGINAL.requestAnimationFrame(watchdogLoop);
    }
    function stopWatchdogs(){
      try{ if(rafId && ORIGINAL.cancelAnimationFrame) ORIGINAL.cancelAnimationFrame(rafId); }catch{}
      rafId=null;
    }

    function inResumeGrace(){
      if(resumeGraceFrames>0){ resumeGraceFrames--; return true; }
      if(Date.now() < resumeGraceUntil) return true;
      return false;
    }

    function watchdogLoop(){
      try{
        if(locked || !hasStarted) return;

        if(quizFrame.style.display !== 'block'){
          rafId = ORIGINAL.requestAnimationFrame(watchdogLoop);
          return;
        }

        // During immediate post-start/resume, skip checks
        const inGrace = inResumeGrace();

        // Focus
        if(!inGrace){
          try{ if(!ORIGINAL.hasFocus()) warnStrike('Lost focus'); }catch{ warnStrike('Focus check error'); }
        }

        // Visibility
        if(!inGrace){
          try{ const vis=document.visibilityState||ORIGINAL.visGet(); if(vis!=='visible') warnStrike('Tab hidden'); }catch{ warnStrike('Visibility check error'); }
        }

        // Fullscreen (with grace)
        try{
          if(!inFullscreen()){
            if(!fsGraceUntil) fsGraceUntil = Date.now()+FULLSCREEN_GRACE_MS;
            if(Date.now() > fsGraceUntil && !inGrace) warnStrike('Fullscreen exited');
          } else {
            fsGraceUntil = 0;
          }
        }catch{ warnStrike('Fullscreen check error'); }

        // Performance drift
        try{
          const now=ORIGINAL.perfNow();
          const dt=now - lastPerf;
          // ignore huge gaps if in grace
          if(!inGrace && dt > PERF_GAP_MS) warnStrike('Performance gap (backgrounded)');
          lastPerf = now;
        }catch{ warnStrike('Performance check error'); }

      }catch{ warnStrike('Watchdog error'); }

      rafId = ORIGINAL.requestAnimationFrame(watchdogLoop);
    }

    /* ===== Page lifecycle ===== */
    showOverlay('Click Start to Begin Quiz','Before starting, only opening DevTools will block you. After starting, policy applies.');

    on(window,'unload',()=>{
      preQuizIntervals.forEach(id=>clearInterval(id));
      postStartIntervals.forEach(id=>clearInterval(id));
      stopWatchdogs();
    });

  })();
  </script>
</body>
</html>
