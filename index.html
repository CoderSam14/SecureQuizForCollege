<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strict Secure Quiz — Hardened (Stable)</title>
  <style>
    html,body{height:100%;width:100%;margin:0;padding:0;background:#000;font-family:Inter, Arial, sans-serif;overflow:hidden}
    iframe{width:100%;height:100%;border:0;display:none}
    #overlay{
      position:fixed;inset:0;background:#000;z-index:99999;display:flex;flex-direction:column;
      justify-content:center;align-items:center;color:#fff;padding:24px;text-align:center;
    }
    #overlay h1{margin:0 0 12px;font-size:22px}
    #overlay p{margin:8px 0;color:#ddd}
    button{
      font-size:16px;padding:12px 20px;border-radius:10px;border:0;cursor:pointer;margin:8px;
    }
    #startBtn{background:#0b9d58;color:#fff}
    #resumeBtn{background:#f59f00;color:#fff;display:none}
    .small{font-size:12px;color:#aaa;margin-top:8px}

    /* Non-destructive UX hardening */
    * { -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent }
    body { -webkit-user-drag:none; user-drag:none }
    ::-webkit-scrollbar{display:none}
    ::selection{background:transparent} ::-moz-selection{background:transparent}
    img{ -webkit-user-drag:none; user-drag:none; pointer-events:none }
  </style>
</head>
<body>

  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayText">
    <h1 id="overlayText">Click Start to Begin Quiz</h1>
    <div>
      <button id="startBtn">Start Quiz</button>
      <button id="resumeBtn">Resume Quiz</button>
    </div>
    <p class="small">This page enforces fullscreen & focus. Leaving the quiz or tampering will be recorded.</p>
  </div>

  <iframe id="quizFrame" src="https://vitapcolab129.examly.io/login" title="Quiz"></iframe>

  <script>
  (function(){
    'use strict';

    /**********************************************************************
     * Stable hardened wrapper
     * - Replaces blocking `debugger;` with non-blocking timing heuristics
     * - Keeps watchdogs and tamper-evidence but avoids breaking runtime
     **********************************************************************/

    // ===== Basic UI & state
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlayText');
    const startBtn = document.getElementById('startBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const quizFrame = document.getElementById('quizFrame');

    let violations = 0;
    const maxViolations = 4;
    const violationLog = [];

    function showOverlay(text){
      if (text) overlayText.innerText = text;
      overlay.style.display = 'flex';
    }
    function hideOverlay(){
      overlay.style.display = 'none';
    }
    function endQuiz(){
      quizFrame.style.display = 'none';
      showOverlay('❌ Quiz ended due to repeated violations.');
      resumeBtn.style.display = 'none';
      startBtn.style.display = 'none';
      stopWatchdogs();
    }
    function recordViolation(reason){
      try {
        violations++;
        const ts = new Date().toISOString();
        violationLog.push({ts, reason});
        console.warn('Quiz Violation:', reason, `(${violations}/${maxViolations})`);
      } catch(e){}
      if (violations >= maxViolations) {
        endQuiz();
      } else {
        try {
          quizFrame.style.display = 'none';
          showOverlay(`⚠️ ${reason}\n(${violations}/${maxViolations})\nClick Resume to continue.`);
          startBtn.style.display = 'none';
          resumeBtn.style.display = 'inline-block';
        } catch(e){}
      }
    }

    // ===== Bind originals early
    const ORIGINAL = {
      addEventListener: EventTarget.prototype.addEventListener,
      removeEventListener: EventTarget.prototype.removeEventListener,
      hasFocus: document.hasFocus.bind(document),
      requestAnimationFrame: window.requestAnimationFrame.bind(window),
      cancelAnimationFrame: window.cancelAnimationFrame ? window.cancelAnimationFrame.bind(window) : null,
      performanceNow: (performance && performance.now) ? performance.now.bind(performance) : Date.now.bind(Date),
      visibilityState: (() => {
        const d = Object.getOwnPropertyDescriptor(Document.prototype, 'visibilityState');
        return d && d.get ? d.get.bind(document) : () => document.visibilityState;
      })(),
    };
    try{ Object.defineProperty(window, '__quizSecureMarker', {value:true, configurable:false, writable:false}); }catch{}

    function trustedAddEvent(target, type, handler, opts){
      try { ORIGINAL.addEventListener.call(target, type, handler, opts); }
      catch { target.addEventListener(type, handler, opts); }
    }

    // ===== Fullscreen helpers
    function requestFullscreen(){
      const el = document.documentElement;
      const rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen || el.webkitEnterFullscreen;
      if (rfs) { try { return Promise.resolve(rfs.call(el)); } catch(e) { return Promise.resolve(); } }
      return Promise.resolve();
    }
    function isBrowserUIFullscreen(){
      return Math.abs(window.innerHeight - screen.availHeight) <= 1 && Math.abs(window.innerWidth - screen.availWidth) <= 1;
    }
    function ensureFullscreen(){
      const fsEl = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null;
      return !!fsEl || isBrowserUIFullscreen();
    }

    // ===== Start/Resume handlers
    function startQuiz(){
      initializeTamperWatch();
      requestFullscreen().then(() => {
        hideOverlay();
        quizFrame.style.display = 'block';
        setTimeout(startWatchdogs, 300);
      });
    }
    startBtn.addEventListener('click', startQuiz);
    resumeBtn.addEventListener('click', () => {
      requestFullscreen().then(() => {
        hideOverlay();
        quizFrame.style.display = 'block';
        setTimeout(startWatchdogs, 300);
      });
    });

    trustedAddEvent(document, 'keydown', (e) => {
      if (e.key === 'F11') {
        requestFullscreen().then(() => {
          hideOverlay();
          quizFrame.style.display = 'block';
          setTimeout(startWatchdogs, 300);
        });
      }
    }, {capture:true});

    // ===== Non-blocking DevTools detection (safe)
    // 1) timing of a small no-op function & Function.prototype.toString call
    // 2) window size gap heuristic
    (function setupDevtoolsSignals(){
      // Timing heuristic using Function.prototype.toString (non-blocking)
      setInterval(() => {
        try {
          const t0 = ORIGINAL.performanceNow();
          // Call toString on a small function - sometimes slower when DevTools are open
          // This is non-blocking and doesn't use `debugger;`
          const fnStr = Function.prototype.toString.call(function(){});
          const dt = ORIGINAL.performanceNow() - t0;
          if (dt > 150) { // threshold in ms - tune as needed
            recordViolation('DevTools timing anomaly detected');
          }
        } catch(e){ /* ignore errors — detection best-effort */ }
      }, 2000);

      // Window gap heuristic: when DevTools open docked it often changes outer vs inner sizes
      setInterval(() => {
        try {
          const gapH = Math.abs(window.outerHeight - window.innerHeight);
          const gapW = Math.abs(window.outerWidth - window.innerWidth);
          // if large gap, likely docked devtools or resize
          if (gapH > 160 || gapW > 160) {
            recordViolation('Developer tools window heuristic triggered');
          }
        } catch(e){ }
      }, 1500);
    })();

    // ===== Disable context menu (UX deterrent)
    trustedAddEvent(document, 'contextmenu', (e) => {
      e.preventDefault(); e.stopPropagation();
      recordViolation('Right-click/context menu attempt');
      return false;
    }, {capture:true});

    // ===== Key combos deterrence (advisory)
    trustedAddEvent(window, 'keydown', (e) => {
      const k = (e.key || '').toLowerCase();
      const isCloseCombo = (e.ctrlKey || e.metaKey) && (k === 'w' || k === 'q');
      const isDevTools = e.key === 'F12'
        || (e.ctrlKey && e.shiftKey && ['i','j','c','k'].includes(k))
        || (e.ctrlKey && k === 'u')
        || (e.metaKey && e.altKey && k === 'i');
      const isRefresh = (e.ctrlKey && (k === 'r')) || (k === 'f5') || (e.ctrlKey && e.shiftKey && k === 'r') || (e.metaKey && k === 'r');
      if (isCloseCombo || isDevTools || isRefresh) {
        e.preventDefault(); e.stopPropagation();
        recordViolation(isCloseCombo ? 'Attempted close (keyboard shortcut)'
                      : isRefresh ? 'Attempted refresh (keyboard shortcut)'
                      : 'Attempt to open developer tools');
        return false;
      }
    }, {capture:true});

    // beforeunload detection
    trustedAddEvent(window, 'beforeunload', (e) => {
      recordViolation('Attempted to close or reload window');
      e.preventDefault(); e.returnValue = ''; return '';
    }, {capture:true});

    // ===== Watchdog via rAF
    let lastPerf = ORIGINAL.performanceNow();
    let rafId = null;
    let fsGraceUntil = 0;
    const CONFIG = {
      fullscreenRequired: true,
      fullscreenGraceMs: 3500,
      perfGapMs: 2000,
    };

    function primaryWatchdogLoop(){
      try{
        // Focus
        if (quizFrame.style.display === 'block') {
          const focused = ORIGINAL.hasFocus();
          if (!focused) recordViolation('Window lost focus');
        }
        // Visibility
        const visState = document.visibilityState || (ORIGINAL.visibilityState ? ORIGINAL.visibilityState() : 'visible');
        if (quizFrame.style.display === 'block' && visState !== 'visible') {
          recordViolation('Tab not visible');
        }
        // Fullscreen with grace
        if (quizFrame.style.display === 'block' && !ensureFullscreen()) {
          if (!fsGraceUntil) fsGraceUntil = Date.now() + CONFIG.fullscreenGraceMs;
          if (CONFIG.fullscreenRequired && Date.now() > fsGraceUntil) {
            recordViolation('Fullscreen not active');
          }
        } else {
          fsGraceUntil = 0;
        }
        // Perf drift
        const now = ORIGINAL.performanceNow();
        if ((now - lastPerf) > CONFIG.perfGapMs && quizFrame.style.display === 'block') {
          recordViolation('Large performance gap (possible backgrounding)');
        }
        lastPerf = now;
      }catch(err){
        recordViolation('Watchdog error (possible tampering)');
      }
      rafId = ORIGINAL.requestAnimationFrame(primaryWatchdogLoop);
    }

    function startWatchdogs(){
      if (!rafId) rafId = ORIGINAL.requestAnimationFrame(primaryWatchdogLoop);
    }
    function stopWatchdogs(){
      try{ if (rafId && ORIGINAL.cancelAnimationFrame) ORIGINAL.cancelAnimationFrame(rafId); }catch{}
      rafId = null;
    }

    // Visibility + fullscreen change hooks
    trustedAddEvent(document, 'visibilitychange', () => {
      if (document.hidden && quizFrame.style.display === 'block') {
        recordViolation('document became hidden');
      }
    }, {capture:true});
    ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(evt => {
      trustedAddEvent(document, evt, () => {
        if (!ensureFullscreen() && quizFrame.style.display === 'block') {
          if (!fsGraceUntil) fsGraceUntil = Date.now() + CONFIG.fullscreenGraceMs;
          if (Date.now() > fsGraceUntil) recordViolation('Exited fullscreen');
        }
      }, {capture:true});
    });

    // ===== Tamper-evidence (lightweight, non-breaking)
    (function fingerprintSelf(){
      try {
        const scripts = Array.from(document.getElementsByTagName('script'));
        const mine = scripts.find(s => s.textContent && s.textContent.includes('Hardened Secure Quiz'));
        if (!mine || !crypto?.subtle) return;
        const text = mine.textContent.trim();
        const enc = new TextEncoder();
        crypto.subtle.digest('SHA-256', enc.encode(text)).then(buf => {
          const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
          try { Object.defineProperty(window, '__quizScriptFingerprint', { value: hex, configurable:false, writable:false }); } catch {}
        }).catch(()=>{});
      } catch {}
    })();
    setInterval(() => {
      try{
        if (!window.__quizScriptFingerprint || !crypto?.subtle) return;
        const scripts = Array.from(document.getElementsByTagName('script'));
        const mine = scripts.find(s => s.textContent && s.textContent.includes('Hardened Secure Quiz'));
        if (!mine) return;
        const enc = new TextEncoder();
        crypto.subtle.digest('SHA-256', enc.encode(mine.textContent.trim())).then(buf => {
          const nowHex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
          if (nowHex !== window.__quizScriptFingerprint) {
            recordViolation('Script fingerprint changed (possible tampering).');
          }
        }).catch(()=>{});
      }catch{}
    }, 5000);

    // ===== Defensive initializer
    function initializeTamperWatch(){
      try{
        if (EventTarget.prototype.addEventListener !== ORIGINAL.addEventListener) {
          try { EventTarget.prototype.addEventListener = ORIGINAL.addEventListener; } catch {}
        }
      }catch{}
      // Start watchdogs when called
      startWatchdogs();
    }

    // ===== Initial UI
    showOverlay('Click Start to Begin Quiz');

    // ===== Cleanup on unload
    trustedAddEvent(window, 'unload', () => {
      stopWatchdogs();
      try { console.log('Final violations log:', violationLog); } catch {}
    });

  })();
  </script>
</body>
</html>
