<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strict Secure Quiz — Hardened (Patched, Encoded iframe)</title>
  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; background: #000; font-family: Inter, Arial, sans-serif; overflow: hidden; }
    iframe { width: 100%; height: 100%; border: 0; display: none; }
    #overlay {
      position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; flex-direction: column;
      justify-content: center; align-items: center; color: #fff; padding: 24px; text-align: center; outline: none;
    }
    #overlay:focus { outline: 2px solid #0b9d58; outline-offset: -2px; }
    #overlay h1 { margin: 0 0 12px; font-size: 22px; }
    #overlay p { margin: 8px 0; color: #ddd; }
    button { font-size: 16px; padding: 12px 20px; border-radius: 10px; border: 0; cursor: pointer; margin: 8px; }
    button:focus { outline: 2px solid #fff; outline-offset: 2px; }
    #startBtn { background: #0b9d58; color: #fff; }
    #resumeBtn { background: #f59f00; color: #fff; display: none; }
    .small { font-size: 12px; color: #aaa; margin-top: 8px; }
  </style>
</head>
<body>

  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayText" aria-live="assertive" tabindex="-1">
    <h1 id="overlayText">Click Start to Begin Quiz</h1>
    <div>
      <button id="startBtn" autofocus>Start Quiz</button>
      <button id="resumeBtn" style="display:none">Resume Quiz</button>
    </div>
    <p class="small">This page encourages fullscreen & focus. Leaving may pause the quiz and be logged.</p>
  </div>

  <!-- NOTE: src removed from static HTML. URL is encoded and attached dynamically on Start / Resume. -->
  <iframe id="quizFrame"
    title="Quiz"
    allow="fullscreen"
    sandbox="allow-forms allow-scripts allow-same-origin"
    style="display:none;width:100%;height:100%;border:0"
  ></iframe>

  <script>
  (function(){
    'use strict';

    const CONFIG = {
      maxViolations: 4,
      fullscreenRequired: true,
      fullscreenGraceMs: 3500,
      perfGapMs: 2000,
      focusWindowMs: 4000, focusStrikesNeeded: 2,
      fsWindowMs: 5000, fsStrikesNeeded: 2,
      driftWindowMs: 10000, driftStrikesNeeded: 2,

      // Base64-encoded quiz URL
      // Example: btoa('https://vitapcolab129.examly.io/login')
      iframeUrlB64: 'aHR0cHM6Ly92aXRhcGNvbGFiMTI5LmV4YW1seS5pby9sb2dpbg=='
    };

    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlayText');
    const startBtn = document.getElementById('startBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const quizFrame = document.getElementById('quizFrame');

    let violations = 0;
    const violationLog = [];

    const ORIGINAL = {
      addEventListener: EventTarget.prototype.addEventListener,
      removeEventListener: EventTarget.prototype.removeEventListener,
      hasFocus: document.hasFocus.bind(document),
      requestAnimationFrame: window.requestAnimationFrame.bind(window),
      cancelAnimationFrame: window.cancelAnimationFrame ? window.cancelAnimationFrame.bind(window) : null,
      performanceNow: performance && performance.now ? performance.now.bind(performance) : () => Date.now(),
      visibilityState: Object.getOwnPropertyDescriptor(Document.prototype, 'visibilityState') ?
                       Object.getOwnPropertyDescriptor(Document.prototype, 'visibilityState').get.bind(document) :
                       () => document.visibilityState,
    };

    function trustedAddEvent(target, type, handler, opts){
      try { ORIGINAL.addEventListener.call(target, type, handler, opts); }
      catch { target.addEventListener(type, handler, opts); }
    }

    function showOverlay(text){
      overlayText.innerText = text;
      overlay.style.display = 'flex';
      overlay.focus();
    }
    function hideOverlay(){
      overlay.style.display = 'none';
      startBtn.focus();
    }

    function requestFullscreen(){
      const el = document.documentElement;
      const rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen || el.webkitEnterFullscreen;
      if (rfs) return Promise.resolve(rfs.call(el)).catch(() => {});
      return Promise.resolve();
    }

    function isBrowserUIFullscreen(){
      return Math.abs(window.innerHeight - screen.availHeight) <= 1 && Math.abs(window.innerWidth - screen.availWidth) <= 1;
    }

    function ensureFullscreen(){
      const fsEl = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null;
      return !!fsEl || isBrowserUIFullscreen();
    }

    function endQuiz(){
      quizFrame.style.display = 'none';
      overlay.style.display = 'flex';
      overlayText.innerText = '❌ Quiz ended due to repeated violations.';
      resumeBtn.style.display = 'none';
      startBtn.style.display = 'none';
    }

    function recordViolation(reason){
      const entry = { ts: new Date().toISOString(), reason, count: violations + 1 };
      violationLog.push(entry);
      violations++;
      console.warn('Quiz Violation:', reason, `(${violations}/${CONFIG.maxViolations})`);

      if (violations >= CONFIG.maxViolations) {
        endQuiz();
      } else {
        quizFrame.style.display = 'none';
        overlay.style.display = 'flex';
        startBtn.style.display = 'none';
        resumeBtn.style.display = 'block';
        overlayText.innerText = `⚠️ ${reason}\n(${violations}/${CONFIG.maxViolations})\nClick Resume to continue.`;
      }
    }

    function makeStrike(windowMs, needStrikes){
      const buf = [];
      return function(){
        const now = Date.now();
        buf.push(now);
        while (buf.length && now - buf[0] > windowMs) buf.shift();
        return buf.length >= needStrikes;
      };
    }

    const focusStrike = makeStrike(CONFIG.focusWindowMs, CONFIG.focusStrikesNeeded);
    const fsStrike = makeStrike(CONFIG.fsWindowMs, CONFIG.fsStrikesNeeded);
    const driftStrike = makeStrike(CONFIG.driftWindowMs, CONFIG.driftStrikesNeeded);

    // ----------------------------
    // iframe attach/mask helpers
    // ----------------------------
    function decodeIframeUrl(){
      try { return atob(CONFIG.iframeUrlB64); } catch(e){ return null; }
    }

    function attachIframeSrcMasked(){
      const url = decodeIframeUrl();
      if (!url) return;
      try {
        quizFrame.src = url;  // load the iframe
        quizFrame.dataset._attached = Date.now();
        // Mask the attribute, but keep the property
        setTimeout(() => {
          try {
            quizFrame.setAttribute('src', 'about:blank'); 
          } catch(e){}
        }, 2500);
      } catch(e){}
    }

    // ----------------------------
    // Start/Resume
    // ----------------------------
    function startQuiz(){
      attachIframeSrcMasked();
      requestFullscreen().then(() => {
        hideOverlay();
        quizFrame.style.display = 'block';
        setTimeout(startWatchdogs, 300);
      });
    }

    startBtn.addEventListener('click', startQuiz);
    resumeBtn.addEventListener('click', () => {
      attachIframeSrcMasked();
      requestFullscreen().then(() => {
        hideOverlay();
        quizFrame.style.display = 'block';
        setTimeout(startWatchdogs, 300);
      });
    });

    trustedAddEvent(document, 'keydown', (e) => {
      if (e.key === 'F11') {
        attachIframeSrcMasked();
        requestFullscreen().then(() => {
          hideOverlay();
          quizFrame.style.display = 'block';
          setTimeout(startWatchdogs, 300);
        });
      }
    }, { capture: true });

    // ----------------------------
    // Violation monitors
    // ----------------------------
    trustedAddEvent(window, 'keydown', (e) => {
      const k = (e.key || '').toLowerCase();
      const isCloseCombo = (e.ctrlKey || e.metaKey) && (k === 'w' || k === 'q');
      const isDevTools = e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['i','j','c','k'].includes(k)) || (e.ctrlKey && k === 'u') || (e.metaKey && e.altKey && k === 'i');
      if (isCloseCombo || isDevTools) {
        e.preventDefault(); e.stopPropagation();
        recordViolation(isCloseCombo ? 'Attempted close (keyboard shortcut)' : 'Attempt to open developer tools');
        return false;
      }
    }, { capture: true });

    trustedAddEvent(document, 'contextmenu', (e) => {
      e.preventDefault(); e.stopPropagation();
      recordViolation('Right-click/context menu attempt');
      return false;
    }, { capture: true });

    trustedAddEvent(window, 'beforeunload', (e) => {
      recordViolation('Attempted to close or reload window');
      e.preventDefault(); e.returnValue = ''; return '';
    }, { capture: true });

    // ----------------------------
    // Watchdog
    // ----------------------------
    let lastPerf = ORIGINAL.performanceNow();
    let rafId = null;
    let fsGraceUntil = 0;

    function primaryWatchdogLoop(){
      try {
        const focused = ORIGINAL.hasFocus();
        if (!focused && quizFrame.style.display === 'block') {
          if (focusStrike()) recordViolation('Window lost focus');
        }

        const visHidden = (typeof document.hidden === 'boolean') ? document.hidden : (ORIGINAL.visibilityState ? ORIGINAL.visibilityState() !== 'visible' : false);
        const visState = document.visibilityState || (ORIGINAL.visibilityState ? ORIGINAL.visibilityState() : 'visible');
        if ((visHidden || visState !== 'visible') && quizFrame.style.display === 'block') {
          if (focusStrike()) recordViolation('Tab not visible');
        }

        if (!ensureFullscreen() && quizFrame.style.display === 'block') {
          if (!fsGraceUntil) fsGraceUntil = Date.now() + CONFIG.fullscreenGraceMs;
          if (CONFIG.fullscreenRequired && Date.now() > fsGraceUntil) {
            if (fsStrike()) recordViolation('Fullscreen not active');
          }
        } else {
          fsGraceUntil = 0;
        }

        const now = ORIGINAL.performanceNow();
        const delta = now - lastPerf;
        if (delta > CONFIG.perfGapMs && quizFrame.style.display === 'block') {
          if (driftStrike()) recordViolation('Large performance gap (possible backgrounding)');
        }
        lastPerf = now;
      } catch (err) {
        recordViolation('Watchdog error (possible tampering)');
      }
      rafId = ORIGINAL.requestAnimationFrame(primaryWatchdogLoop);
    }

    function startWatchdogs(){
      if (!rafId) rafId = ORIGINAL.requestAnimationFrame(primaryWatchdogLoop);
    }

    function stopWatchdogs(){
      try { if (rafId && ORIGINAL.cancelAnimationFrame) ORIGINAL.cancelAnimationFrame(rafId); } catch {}
      rafId = null;
    }

    trustedAddEvent(document, 'visibilitychange', () => {
      if (document.hidden && quizFrame.style.display === 'block') {
        if (focusStrike()) recordViolation('document became hidden');
      }
    }, { capture: true });

    ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'].forEach(evt => {
      trustedAddEvent(document, evt, () => {
        if (!ensureFullscreen() && quizFrame.style.display === 'block') {
          if (CONFIG.fullscreenRequired) {
            if (!fsGraceUntil) fsGraceUntil = Date.now() + CONFIG.fullscreenGraceMs;
            if (Date.now() > fsGraceUntil && fsStrike()) recordViolation('Exited fullscreen');
          }
        }
      }, { capture: true });
    });

    trustedAddEvent(window, 'unload', () => {
      stopWatchdogs();
      console.log('Final violations log:', violationLog);
    });

    // Expose internals for dev-only test harness (remove in production)
    try { window.__secureQuizInternals = { recordViolation: recordViolation, violationLog: violationLog }; } catch(e){}

    showOverlay('Click Start to Begin Quiz');

  })();
  </script>
</body>
</html>
